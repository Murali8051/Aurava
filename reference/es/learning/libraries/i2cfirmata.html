<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title>I2CFirmata \ Learning \ Wiring</title>
		
		<link rel="icon" href="img/wiring-1.ico" type="image/x-icon" />
		<link rel="shortcut icon" href="img/wiring-1.ico" type="image/x-icon" />
		
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="Author" content="Hernando Barragán" />
		<meta name="Publisher" content="Wiring" />
		<meta name="Keywords" content="Wiring, Processing, Interactive Media, Electronic Arts, Programming, C, C++, Hernando Barragán" />
		<meta name="Description" content="Wiring is an electronic sketchbook and hardware electronics for developing 
				ideas. It is a context for learning fundamentals of computer programming and prototyping with electronics
				within the context of the electronic arts." />
		<meta name="Copyright" content="All contents copyright Hernando Barragán" />
		
		<script src="../../javascript/MM_functions.js" type="text/javascript"></script>
	
		<link href="../../css/style.css" rel="stylesheet" type="text/css" />
	</head>
	<body id="Library" onload="" >
		
		<!-- ==================================== PAGE ============================ --> 
		<div id="container">
	
			<!-- ==================================== HEADER ============================ --> 
			<div id="header">
				<a href="../../index.html"><img src="../../img/wiring_cover.gif" alt="Wiring cover" title="Back to the reference index." /></a>
				<form name="search" method="get" action="http://www.google.com/search">
				<label>Search wiring.org.co:</label> 
				       <p><input type="hidden" name="as_sitesearch" value="wiring.org.co" />
				       <input type="text" name="as_q" value="" size="20" class="text" /> 
						<input type="image" src="../../img/search_button.gif" value="Submit" alt="Submit" /></p>
				</form>
			</div> 
						<div id="navigation">
				<div class="navBar" id="mainnav">
					<a href="../../index.html">Framework</a> (<a href="../../alpha.html">A-Z</a>) \ 
					<a href="../../libraries/index.html">Librer&iacute;as</a> \ 
					<a href="../../environment/index.html">Entorno</a> \ 
					<a href="../../learning/index.html" class="active">Aprendiendo</a> \
					<a href="../../hardware/index.html">Hardware</a> 
				</div>
				<div class="navBar learning_local" id="subNav">
					 
 Ejemplos: 					<a href="../../learning/basics/index.html">B&aacute;sicos</a>, 
					<a href="../../learning/libraries/index.html" class="active">Librer&iacute;a</a>, 
					<a href="../../learning/topics/index.html">T&oacute;picos</a> 
				</div>
			</div>

		
			<a id="TOP" name="TOP"></a>
			
			<!-- ==================================== CONTENT - Headers ============================ -->
			<div class="content">
			 
			 
<div class="examples-nav-div">
<table width="480" border="0"><tr><td align="left"><table>
<tr><td><a href="echostring.html">
				<img src="../../img/back_off.gif" alt="Strings accept and echoing" /></a></td><td>
<select name="nav" size="1" class="inputnav" onChange="javascript:gogo(this)">
	<optgroup label="Wire">
		<option value="digitalpotentiometer.html">Digital potentiometer: AD5171</option>
		<option value="masterreader.html">Master reader</option>
		<option value="masterwriter.html">Master writer</option>
		<option value="slavereceiver.html">Slave receiver</option>
		<option value="slavesender.html">Slave sender</option>
		<option value="ultrasonicsfr.html">Ultrasonic ranger: SFR08/SFR10</option>
		<option value="hmc6352sparkfun.html">Compass heading: HMC6352 sparkfun</option>
		<option value="hmc6343sparkfun.html">Compass heading with tilt compensation: HMC6352 sparkfun</option>
		<option value="realtimeclock.html">Real time clock: DS1307 sparkfun</option>
		<option value="bmp085.html">Temperature and barometric pressure: Sparkfun BOSCH BMP085</option>
		<option value="tmp102sparkfun.html">Temperature: Sparkfun tmp102</option>
	</optgroup>
	<optgroup label="SPI">
		<option value="barometricpressuresensor.html">Barometric pressure: SCP1000</option>
		<option value="gyromlx90609.html">MLX90609 Gyroscope: Sparkfun</option>
	</optgroup>
	<optgroup label="Servo">
		<option value="servomotor.html">Servo moving</option>
		<option value="servomultiple.html">Multiple servos</option>
		<option value="servoanaloginput.html">Servo & potentiometer</option>
	</optgroup>
	<optgroup label="Matrix">
		<option value="hellomatrix.html">Hello Matrix</option>
		<option value="spriteanimation.html">Sprite animation</option>
	</optgroup>
	<optgroup label="LiquidCrystal">
		<option value="printdata.html">Printing data to parallel LCD display</option>
	</optgroup>
	<optgroup label="Encoder">
		<option value="encoderread.html">Encoder read</option>
	</optgroup>
	<optgroup label="EEPROM">
		<option value="storedata.html">Storing data</option>
	</optgroup>
	<optgroup label="EEPROMVar">
		<option value="helloeepromvar.html">EEPROM data variables</option>
	</optgroup>
	<optgroup label="Firmata">
		<option value="allinputsfirmata.html">All inputs</option>
		<option value="analogfirmata.html">Analog inputs</option>
		<option value="echostring.html">Strings accept and echoing</option>
		<option value="i2cfirmata.html" selected="selected">Wire & Firmata</option>
		<option value="oldstandardfirmata.html">Old Standard protocol</option>
		<option value="servofirmata.html">Servo & Firmata</option>
		<option value="simpleanalogfirmata.html">Analog input/output pins</option>
		<option value="simpledigitalfirmata.html">Digital input/output pins</option>
		<option value="standardfirmata.html">Standard protocol</option>
	</optgroup>
	<optgroup label="NewSoftSerial">
		<option value="newsoftserialtest.html">Software serial port test</option>
		<option value="twonsstest.html">Two ports</option>
	</optgroup>
	<optgroup label="Stepper">
		<option value="steppermove.html">Stepper move</option>
	</optgroup>
	<optgroup label="NMEA">
		<option value="basicpositioning.html">Basic positioning</option>
		<option value="coursetodestination.html">Course to destination</option>
		<option value="determiningspeed.html">Determining speed</option>
		<option value="distancetodestination.html">Distance to destination</option>
		<option value="nmeasentence.html">NMEA Sentence</option>
	</optgroup>
	<optgroup label="Button">
		<option value="button.html">Button object</option>
		<option value="eventbutton.html">Event API for buttons</option>
		<option value="pollingcomplexbutton.html">Button polling technique</option>
	</optgroup>
	<optgroup label="Constrain">
		<option value="simpleconstrain.html">Constrained variables</option>
	</optgroup>
	<optgroup label="FluentPrint">
		<option value="hellofluentprint.html">Hello fluent print</option>
	</optgroup>
	<optgroup label="FSM">
		<option value="ledstatemachine.html">LED state machine</option>
	</optgroup>
	<optgroup label="HashMap">
		<option value="hellohashmap.html">Hello Hashmap</option>
	</optgroup>
	<optgroup label="Keypad">
		<option value="customkeypad.html">Custom Keypad</option>
		<option value="dynamickeypad.html">Dynamic Keypad</option>
		<option value="eventkeypad.html">Event Keypad</option>
		<option value="hellokeypad.html">Hello Keypad</option>
	</optgroup>
	<optgroup label="LED">
		<option value="blink.html">Blink</option>
		<option value="loop.html">Loop</option>
	</optgroup>
	<optgroup label="MenuBackend">
		<option value="hellomenu.html">Hello Menu</option>
	</optgroup>
	<optgroup label="OSC">
		<option value="helloosc.html">Hello OSC (Open Sound Control)</option>
	</optgroup>
	<optgroup label="Messenger">
		<option value="basic_communication.html">Basic communication</option>
		<option value="checkstring.html">Check string</option>
		<option value="copystring.html">Copy string</option>
	</optgroup>
	<optgroup label="Password">
		<option value="hellopassword.html">Hello Password</option>
		<option value="passwordkeypad.html">Password Keypad</option>
		<option value="serialmonitor.html">Serial Monitor</option>
	</optgroup>
	<optgroup label="Potentiometer">
		<option value="potcontrol_led.html">PotControl LED</option>
		<option value="potdemo.html">Pot Demo</option>
	</optgroup>
	<optgroup label="Scheduler">
		<option value="delayedsignal.html">Delayed Signal</option>
	</optgroup>
	<optgroup label="Supervisor">
		<option value="hellosupervisor.html">Hello Supervisor</option>
	</optgroup>
	<optgroup label="TimedAction">
		<option value="hellotimedaction.html">Hello Timed Action</option>
		<option value="threeexamplesatonce.html">Three Examples At Once</option>
	</optgroup>
</select>

</td><td><a class="next" href="oldstandardfirmata.html">
				<img src="../../img/next_off.gif" alt="Old Standard protocol" /></a></td></tr></table></td></tr></table></div>

<p class="ref-notice">This example is for Wiring version 1.0 build 0100+. If you have a previous version, use the examples included with your software. <em>If you see any errors or have comments, please <a href="http://forum.wiring.co/index.php/board,13.0.html">let us know</a>.</em></p>


<div class="example">Copyright (C) 2009 Jeff Hoefs.  All rights reserved. Copyright (C) 2009 Shigeru Kobayashi.  All rights reserved. <br />
<br />
 This library is free software; you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation; either version 2.1 of the License, or (at your option) any later version. See file LICENSE.txt for further informations on licensing terms.</p>
<p></p>

<p class="doc">
<pre class="code">
#<span class='keyword1'>include</span> &lt;Wire.h&gt;
#<span class='keyword1'>include</span> &lt;Firmata.h&gt;


#<span class='keyword1'>define</span> I2C_WRITE B00000000
#<span class='keyword1'>define</span> I2C_READ B00001000
#<span class='keyword1'>define</span> I2C_READ_CONTINUOUSLY B00010000
#<span class='keyword1'>define</span> I2C_STOP_READING B00011000
#<span class='keyword1'>define</span> I2C_READ_WRITE_MODE_MASK B00011000

#<span class='keyword1'>define</span> MAX_QUERIES 8

<span class='keyword1'>unsigned</span> <span class='keyword1'>long</span> currentMillis;     <span class='comment'>// store the current value from <span class='keyword2'>millis</span>()</span>
<span class='keyword1'>unsigned</span> <span class='keyword1'>long</span> previousMillis;    <span class='comment'>// <span class='keyword1'>for</span> comparison with currentMillis</span>
<span class='keyword1'>unsigned</span> <span class='keyword1'>int</span> samplingInterval = 32;  <span class='comment'>// <span class='keyword1'>default</span> sampling interval is 33ms</span>
<span class='keyword1'>unsigned</span> <span class='keyword1'>int</span> i2cReadDelayTime = 0;  <span class='comment'>// <span class='keyword1'>default</span> <span class='keyword2'>delay</span> time between i2c <span class='keyword2'>read</span> request and Wire.requestFrom()</span>
<span class='keyword1'>unsigned</span> <span class='keyword1'>int</span> powerPinsEnabled = 0;  <span class='comment'>// use as <span class='keyword1'>boolean</span> to prevent enablePowerPins from being called more than once</span>

#<span class='keyword1'>define</span> MINIMUM_SAMPLING_INTERVAL 10

#<span class='keyword1'>define</span> REGISTER_NOT_SPECIFIED -1

struct i2c_device_info {
  <span class='keyword1'>byte</span> addr;
  <span class='keyword1'>byte</span> reg;
  <span class='keyword1'>byte</span> bytes;
};

i2c_device_info query[MAX_QUERIES];

<span class='keyword1'>byte</span> i2cRxData[32];
<span class='keyword1'>boolean</span> readingContinuously = <span class='keyword1'>false</span>;
<span class='keyword1'>byte</span> queryIndex = 0;

<span class='keyword1'>void</span> readAndReportData(<span class='keyword1'>byte</span> address, <span class='keyword1'>int</span> theRegister, <span class='keyword1'>byte</span> numBytes)
{
  <span class='keyword1'>if</span> (theRegister != REGISTER_NOT_SPECIFIED) {
    Wire.beginTransmission(address);
    Wire.<span class='keyword2'>write</span>(theRegister);
    Wire.endTransmission();
    <span class='keyword2'>delayMicroseconds</span>(i2cReadDelayTime);  <span class='comment'>// <span class='keyword2'>delay</span> is necessary <span class='keyword1'>for</span> some devices such as WiiNunchuck</span>
  } 
  <span class='keyword1'>else</span> {
    theRegister = 0;  <span class='comment'>// fill the register with a dummy value</span>
  }

  Wire.requestFrom(address, numBytes);

  <span class='comment'>// check to be sure correct number of bytes were returned by slave</span>
  <span class='keyword1'>if</span> (numBytes == Wire.<span class='keyword2'>available</span>()) {
    i2cRxData[0] = address;
    i2cRxData[1] = theRegister;
    <span class='keyword1'>for</span> (<span class='keyword1'>int</span> i = 0; i &lt; numBytes; i++) {
      i2cRxData[2 + i] = Wire.<span class='keyword2'>read</span>();
    }
    <span class='comment'>// send slave address, register and received bytes</span>
    Firmata.sendSysex(I2C_REPLY, numBytes + 2, i2cRxData);
  }
  <span class='keyword1'>else</span> {
    <span class='keyword1'>if</span> (numBytes &gt; Wire.<span class='keyword2'>available</span>()) {
      Firmata.sendString(<span class='literal'>"I2C Read Error: Too many bytes received"</span>);
    } <span class='keyword1'>else</span> {
      Firmata.sendString(<span class='literal'>"I2C Read Error: Too few bytes received"</span>); 
    }
  }
  
}

<span class='keyword1'>void</span> sysexCallback(<span class='keyword1'>byte</span> command, <span class='keyword1'>byte</span> argc, <span class='keyword1'>byte</span> *argv)
{
  <span class='keyword1'>byte</span> mode;
  <span class='keyword1'>byte</span> slaveAddress;
  <span class='keyword1'>byte</span> slaveRegister;
  <span class='keyword1'>byte</span> data;
  <span class='keyword1'>int</span>  delayTime;

  <span class='keyword1'>if</span> (command == I2C_REQUEST) {
    mode = argv[1] &amp; I2C_READ_WRITE_MODE_MASK;
    slaveAddress = argv[0];

    <span class='keyword1'>switch</span> (mode) {
    <span class='keyword1'>case</span> I2C_WRITE:
      Wire.beginTransmission(slaveAddress);
      <span class='keyword1'>for</span> (<span class='keyword1'>byte</span> i = 2; i &lt; argc; i += 2) {
        data = argv[i] + (argv[i + 1] &lt;&lt; 7);
        Wire.<span class='keyword2'>write</span>(data);
      }
      Wire.endTransmission();
      <span class='keyword2'>delayMicroseconds</span>(70); <span class='comment'>// TODO is <span class='literal2'><span class='keyword1'>this</span></span> needed?</span>
      <span class='keyword1'>break</span>;
    <span class='keyword1'>case</span> I2C_READ:
      <span class='keyword1'>if</span> (argc == 6) {
        <span class='comment'>// a slave register is specified</span>
        slaveRegister = argv[2] + (argv[3] &lt;&lt; 7);
        data = argv[4] + (argv[5] &lt;&lt; 7);  <span class='comment'>// bytes to <span class='keyword2'>read</span></span>
        readAndReportData(slaveAddress, (<span class='keyword1'>int</span>)slaveRegister, data);
      } 
      <span class='keyword1'>else</span> {
        <span class='comment'>// a slave register is NOT specified</span>
        data = argv[2] + (argv[3] &lt;&lt; 7);  <span class='comment'>// bytes to <span class='keyword2'>read</span></span>
        readAndReportData(slaveAddress, (<span class='keyword1'>int</span>)REGISTER_NOT_SPECIFIED, data);
      }
      <span class='keyword1'>break</span>;
    <span class='keyword1'>case</span> I2C_READ_CONTINUOUSLY:
      <span class='keyword1'>if</span> ((queryIndex + 1) &gt;= MAX_QUERIES) {
        <span class='comment'>// too many queries, just ignore</span>
        Firmata.sendString(<span class='literal'>"too many queries"</span>);
        <span class='keyword1'>break</span>;
      }
      query[queryIndex].addr = slaveAddress;
      query[queryIndex].reg = argv[2] + (argv[3] &lt;&lt; 7);
      query[queryIndex].bytes = argv[4] + (argv[5] &lt;&lt; 7);
      readingContinuously = <span class='keyword1'>true</span>;
      queryIndex++;
      <span class='keyword1'>break</span>;
    <span class='keyword1'>case</span> I2C_STOP_READING:
      readingContinuously = <span class='keyword1'>false</span>;
      queryIndex = 0;
      <span class='keyword1'>break</span>;
    <span class='keyword1'>default</span>:
      <span class='keyword1'>break</span>;
    }
  }
  <span class='keyword1'>else</span> <span class='keyword1'>if</span> (command == SAMPLING_INTERVAL) {
    samplingInterval = argv[0] + (argv[1] &lt;&lt; 7);

    <span class='keyword1'>if</span> (samplingInterval &lt; MINIMUM_SAMPLING_INTERVAL) {
      samplingInterval = MINIMUM_SAMPLING_INTERVAL;
    }

    samplingInterval -= 1;
    Firmata.sendString(<span class='literal'>"sampling interval"</span>);
  }

  <span class='keyword1'>else</span> <span class='keyword1'>if</span> (command == I2C_CONFIG) {
    delayTime = (argv[4] + (argv[5] &lt;&lt; 7));                        <span class='comment'>// MSB</span>
    delayTime = (delayTime &lt;&lt; 8) + (argv[2] + (argv[3] &lt;&lt; 7));     <span class='comment'>// <span class='keyword2'>add</span> LSB</span>

    <span class='keyword1'>if</span> ((argv[0] + (argv[1] &lt;&lt; 7)) &gt; 0) {
      enablePowerPins(PORTC3, PORTC2);
    }

    <span class='keyword1'>if</span> (delayTime &gt; 0) {
      i2cReadDelayTime = delayTime;
    }

    <span class='keyword1'>if</span> (argc &gt; 6) {
      <span class='comment'>// If you extend I2C_Config, handle your data here</span>
    }

  }
}

<span class='keyword1'>void</span> systemResetCallback()
{
  readingContinuously = <span class='keyword1'>false</span>;
  queryIndex = 0;
}

<span class='comment'>/* reference: BlinkM_funcs.h by Tod E. Kurt, ThingM, http:<span class='comment'>//thingm.com/ */</span></span>
<span class='comment'>// Enables Pins <span class='literal2'>A2</span> and <span class='literal2'>A3</span> to be used as GND and Power</span>
<span class='comment'>// so that I2C devices can be plugged directly</span>
<span class='comment'>// into Arduino header (pins <span class='literal2'>A2</span> - <span class='literal2'>A5</span>)</span>
<span class='keyword1'>static</span> <span class='keyword1'>void</span> enablePowerPins(<span class='keyword1'>byte</span> pwrpin, <span class='keyword1'>byte</span> gndpin)
{
  <span class='keyword1'>if</span> (powerPinsEnabled == 0) {
    DDRC |= _BV(pwrpin) | _BV(gndpin);
    PORTC &amp;=~ _BV(gndpin);
    PORTC |=  _BV(pwrpin);
    powerPinsEnabled = 1;
    Firmata.sendString(<span class='literal'>"Power pins enabled"</span>);
    <span class='keyword2'>delay</span>(100);
  }
}

<span class='keyword1'>void</span> <span class='keyword2'>setup</span>()
{
  Firmata.setFirmwareVersion(2, 0);

  Firmata.attach(START_SYSEX, sysexCallback);
  Firmata.attach(SYSTEM_RESET, systemResetCallback);

  <span class='keyword1'>for</span> (<span class='keyword1'>int</span> i = 0; i &lt; <span class='literal2'>TOTAL_PINS</span>; ++i) {
    <span class='keyword2'>pinMode</span>(i, <span class='literal2'>OUTPUT</span>);
  }

  Firmata.<span class='keyword2'>begin</span>(57600);  
  Wire.<span class='keyword2'>begin</span>();
}

<span class='keyword1'>void</span> <span class='keyword2'>loop</span>()
{
  <span class='keyword1'>while</span> (Firmata.<span class='keyword2'>available</span>()) {
    Firmata.processInput();
  }

  currentMillis = <span class='keyword2'>millis</span>();
  <span class='keyword1'>if</span> (currentMillis - previousMillis &gt; samplingInterval) {
    previousMillis += samplingInterval;

    <span class='keyword1'>for</span> (<span class='keyword1'>byte</span> i = 0; i &lt; queryIndex; i++) {
      readAndReportData(query[i].addr, query[i].reg, query[i].bytes);
    }
  }
}
</pre>


</div>


			
			</div>

			<!-- ==================================== FOOTER ============================ --> 
  			<div id="footer">
    			<div id="copyright">Wiring is an open project initiated by <a href="http://barraganstudio.com" target="_blank">Hernando Barrag&aacute;n</a>. It is developed by a <a href="http://wiring.org.co/about.html">small team of volunteers</a>.</div>  
		  <div id="colophon">

                    <a href="../../copyright.html">&copy; Info</a>, Processing <a href="http://processing.org/copyright.html">&copy; Info</a></div>
		  </div>
  			
		</div>
	</body>
</html>
